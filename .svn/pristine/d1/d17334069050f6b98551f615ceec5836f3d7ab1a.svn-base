using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web;
using System.Web.Mvc;

using Com.Winfotian.Proxy;
using WinfoToolSys.Pms;
using Proxy;
using Proxy.ServiceWinToolRead;
 
 
namespace WinfoToolSys.Controllers.SiteMng
{
    public class SiteSetMalodorController : Controller
    {
        //
        // GET: /SiteSetMalodor/

        public ActionResult Index()
        {
            return View();
        }

        //添加、详细、修改页面
        public ActionResult ShowDetail(string oper, string configId)
        {
            StringBuilder sb = new StringBuilder();
            var model = ServcieTool.WinToolServiceReadInstance.GetDtuConfigByCode("", configId);

            switch (oper)
            {
                case "Show":
                    ViewBag.Oper = "Show";
                    break;
                case "Edit":
                    ViewBag.Oper = "Edit";
                    sb.Append("<input type='button' class='buttonVer2' value='修改' onclick='' />");
                    break;
                case "Add":
                    ViewBag.Oper = "Add";
                    sb.Append("<input type='button' class='buttonVer2' value='添加' onclick='' />");
                    break;
                default:
                    break;
            }
            sb.Insert(0, "\"");
            sb.Append("\"");
            ViewBag.Button = sb.ToString();
            return View(model);
        }

        [HttpPost]
        public JsonResult GetOdorizationList(string Oper, string ComId, string FieldName)
        {
            var toolService = ServcieTool.WinToolServiceReadInstance;
            //根据站点名查找
            var list = toolService.DtuConfigList(PmsMng.ActiveKey, Oper, new int[] { 1 }.ToList());
            if(ComId == "" && ComId == "0")
                return Json(list);
            //如果有公司选项先查找公司下所以站点
            List< T_Dtu_Ex> dtus = toolService.GetSite(PmsMng.ActiveKey,ComId,FieldName,Oper,false);
            //关联两个表筛选到model
            var model = from row in list join dtu in dtus on row.Dtuid equals dtu.Dtuid
                        select new
                        {
                            Dtuid = row.Dtuid,
                            DtuidName = row.DtuidName,
                            ConfigName = row.ConfigName,
                            ConfigDesc = row.ConfigDesc,
                            ConfigCode = row.ConfigCode,
                            IsAlert = row.IsAlert,
                            IsCreate = row.IsCreate,
                            Status = row.Status
                        };
            return Json(model);
        }
    }
}
